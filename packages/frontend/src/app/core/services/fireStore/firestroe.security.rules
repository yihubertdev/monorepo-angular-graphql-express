rules_version = '2';
service cloud.firestore {
    match /databases/{database}/documents {
        function isAuthMachedUser(uid) {
            return request.auth != null && request.auth.uid == uid;
        }
        function isBelongToAdminOrEditor() {
            let role = get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
            return role=="ADMIN" || role=="EDITOR";
        }

        function isAuthSignedIn() {
            return request.auth != null;
        }

        function currentUserInfo() {
            return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
        }

        function currentBlogInfo(blogId) {
            return get(/databases/$(database)/documents/blogs/$(blogId)).data;
        }

        function currentArticleInfo(articleId) {
            return get(/databases/$(database)/documents/articles/$(articleId)).data;
        }

        function isBlogUserMatchedAuth (blogId) {
            return currentBlogInfo(blogId).userId ==currentUserInfo().userId
        }

        function isArticleUserMatchedAuth (articleId) {
            return currentArticleInfo(articleId).userId ==currentUserInfo().userId
        }

        function isNewDataMatchedUser () {
            return request.resource.data.userId == currentUserInfo().userId
        }

        match /users/{uid}	{
            allow read;
            allow update, delete, create: if isAuthMachedUser(uid);
        }

        match /networth/{uid}	{
            allow read, update, delete, create: if isAuthMachedUser(uid);
        }

        match /users/{uid}/{subCollectionId=**} {
            allow create, delete, get, read, list, update, write: if isAuthMachedUser(uid);
        }

        match /blogs/{blogId}	{
            allow read;
            allow create: if isAuthSignedIn() && isNewDataMatchedUser();
            allow update, delete: if isAuthSignedIn();
        }
        match /article/{articleId} {
            allow read;
            allow create: if request.auth != null && isNewDataMatchedUser();
            allow update, delete: if currentArticleInfo(articleId).userId == currentUserInfo().userId;
        }
    }
}
